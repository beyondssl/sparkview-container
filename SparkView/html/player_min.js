svGlobal.Player=function(p){function G(){l=q=n=0;v=d=null;c.state=c.CLOSED;c.readyState=WebSocket.CONNECTING;r=!1;w=0}function k(a,b){return(a[b]&255)<<24|(a[b+1]&255)<<16|(a[b+2]&255)<<8|a[b+3]&255}function M(){q+=z;c.onprogress(q,n)}function N(a,b){if(c.state!=c.PLAYING)l-=8;else{var e=a.target.result;a=function(){A&&(clearInterval(A),A=0);if(c.onprogress)c.onprogress(b,n);q=b;if(c.state==c.PLAYING){l+=e.byteLength;var g=new Uint8Array(e.slice(0,1));if(153!=g[0]&&152!=g[0])if(D){if(48==g[0])c.onmessage({data:e.slice(2)})}else c.onmessage({data:e});
t(8,B)}else l-=8};if(c.state==c.PLAYING){var f=r?0:b-q;if(10>f||0==q)f=0;r&&0<x&&b>=x&&(d.getDesktop&&d.getDesktop().pause(!1),r=!1,x=0);0<f?v=setTimeout(a,f):a();f>3*z&&(A=setInterval(M,z))}}}function B(a){if(c.state==c.PLAYING){var b=new Int8Array(a.target.result);if(b&&8==b.length){a=k(b,0);var e=k(b,4);0>e&&(console.error("Duration:"+e),e=0);b=function(f){N(f,e)};c.state==c.PLAYING&&(l+=8,t(a,b))}else{if(c.onprogress)c.onprogress(n,n);c.close()}}}function H(a){var b=new Int8Array(a.target.result);
y=String.fromCharCode(b[0],b[1],b[2],b[3]);a=(b[4]&255)<<8|b[5]&255;var e=(b[6]&255)<<8|b[7]&255,f=(b[8]&255)<<8|b[9]&255,g=b[10]&255;q=0;n=k(b,19)<<32|k(b,23);console.log("total time:"+n+" type:"+y+" width:"+e+" height:"+f+" color:"+g);if(e&&f){z=n/100|0;if(d&&d.running())d.resetStatus&&d.resetStatus();else if("RDPV"==y)(b=svManager.getInstance())&&b.close(),d=new svGlobal.Rdp(c,e,f,g),d.displayMsg=!1,d.setTitle=!1,d.addSurface(p),d.run();else if("VNCV"==y)(b=svManager.getInstance())&&b.close(),
d=new svGlobal.Vnc(c,e,f,g),d.displayMsg=!1,d.setTitle=!1,d.addSurface(p),d.run();else if("SSHV"==y)D=!0,(b=svManager.getInstance())&&b.close(),d=new svGlobal.SSH(c,e,f,g),d.displayMsg=!1,d.setTitle=!1,d.addSurface(p),d.run();else if("TELV"==y)D=!0,(b=svManager.getInstance())&&b.close(),d=new svGlobal.TELNET(c,e,f,g),d.displayMsg=!1,d.setTitle=!1,d.addSurface(p),d.run();else{hi5.notifications.notify("Invalid format!");return}c.readyState=WebSocket.OPEN;if(c.onopen)c.onopen();if(c.onopened)c.onopened({width:e,
height:f,color:g,version:a,length:n,size:u.size});l=64;0<x&&d.getDesktop&&d.getDesktop().pause(!0);t(8,B)}else hi5.notifications.notify("Invalid resolution, width:"+e+" height:"+f)}function t(a,b){if(c.state!=c.PLAYING){if(8==a)return;l-=8}C?(b=O,a=u.slice(0,64),h=new FileReader,h.onload=b,h.readAsArrayBuffer(a)):(a=u.slice(l,l+a),h=new FileReader,h.onload=b,h.readAsArrayBuffer(a))}function I(a,b){a=u.slice(a,a+26);h=new FileReader;h.onload=b;h.readAsArrayBuffer(a)}function P(a,b){a=u.slice(a,a+4);
h=new FileReader;h.onload=b;h.readAsArrayBuffer(a)}function O(a){a=new Int8Array(a.target.result);w=k(a,35)<<32|k(a,39);a=function(b){J(b,w)};0==w?K():I(w,a)}function J(a,b){var e=new Int8Array(a.target.result);k(e,0);a=k(e,4);var f=k(e,10)<<32|k(e,14),g=k(e,18)<<32|k(e,22);e=function(m){J(m,g)};var E=function(m){(m=new Int8Array(m.target.result),4==m.length)?(m=k(m,0),Q(f,m,b)):(hi5.notifications.notify("Invalid history object length"),c.close())};a<=x?(d&&d.resetStatus&&d.resetStatus(),P(f,E)):
0==g?K():I(g,e)}function K(){w=0;r;v=l=0;C=!1;t(64,H)}function Q(a,b,e){a+=8;a=u.slice(a,a+b);h=new FileReader;h.onload=function(f){f=new Int8Array(f.target.result);var g=2,E=k(f,g);g+=4;for(var m=0;m<E;m++){var L=k(f,g);g+=4;var R=f.slice(g,g+L);c.onmessage({data:R});g+=L}C=!1;l=e+26;t(8,B)};h.readAsArrayBuffer(a)}var c=this,l=0,q=0,n=0,z=0,A=0,u=null,v=null,d=null,h=null,r=!1,F=!1,x=0,y="",D=!1,w=0,C=!1;this.PLAYING=0;this.PAUSED=1;this.state=this.CLOSED=3;this.readyState=WebSocket.CONNECTING;p||
(p=new svGlobal.LocalInterface);p.setReadOnly(!0);p.hideWhenClose=!1;this.getSurface=function(){return p};this.close=function(){console.log("Player closed");c.readyState=WebSocket.CLOSED;if(d&&d.running())try{if(c.onclose)c.onclose({code:0,reason:""});d&&(d.close(),d=null);if(c.onend)c.onend()}finally{G()}else console.log("no rdp just closed")};this.setSource=function(a){if(h){try{h.abort()}catch(b){}h=null}c.state==c.PLAYING?(c.state=c.CLOSED,F=!0,v&&(clearTimeout(v),v=null),c.close()):(G(),F=!1);
if(a){if(!("slice"in a||(a.slice=a.webkitSlice||a.mozSlice,"slice"in a))){alert(__svi18n.file.slice);return}u=a}else alert(__svi18n.player.noinput)};this.send=function(){};this.play=function(){c.state=c.PLAYING;if(0==l){var a=function(){l=0;t(64,H)};F?setTimeout(a,888):a()}else t(8,B)};this.scan=function(a){r=a};this.pause=function(){c.state=c.PAUSED};this.seek=function(a){d&&(C=r=!0,d.getDesktop&&d.getDesktop().pause(!0),x=parseInt(n*a/100))};this.setVolume=function(a){d&&d.setVolume&&d.setVolume(a)}};
svGlobal.RdpPlayer=svGlobal.Player;
